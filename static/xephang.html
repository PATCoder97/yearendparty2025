<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>B·∫£ng V√†ng T·∫øt üåº</title>
    <style>
        body { background: radial-gradient(circle, #b71c1c 0%, #5d0000 100%); color: #ffd700; font-family: 'Verdana', sans-serif; text-align: center; margin: 0; padding: 20px; }
        h1 { font-size: 3em; text-transform: uppercase; text-shadow: 2px 2px 4px #000; margin-bottom: 10px; }
        .sub-title { color: #fff; margin-bottom: 30px; font-style: italic; }
        
        .board { max-width: 800px; margin: 0 auto; background: rgba(0, 0, 0, 0.5); border-radius: 15px; padding: 20px; border: 2px solid #ffd700; }
        
        /* Th√™m cursor pointer ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt l√† b·∫•m ƒë∆∞·ª£c */
        .rank-item { display: flex; align-items: center; justify-content: space-between; background: #fff; color: #333; margin: 10px 0; padding: 15px 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: transform 0.2s; cursor: pointer; }
        .rank-item:hover { transform: scale(1.02); background-color: #fffde7; }
        
        .rank-number { font-size: 24px; font-weight: bold; width: 40px; }
        .singer-name { flex-grow: 1; text-align: left; font-size: 20px; font-weight: bold; padding-left: 20px; }
        .score-box { text-align: right; }
        .avg-score { font-size: 22px; color: #d50000; font-weight: bold; }
        .vote-count { font-size: 12px; color: #666; }

        .rank-1 { background: linear-gradient(90deg, #fff9c4, #ffd700); border: 2px solid #fff; }
        .rank-2 { background: linear-gradient(90deg, #e0e0e0, #bdbdbd); }
        .rank-3 { background: linear-gradient(90deg, #ffccbc, #ffab91); }

        .loading { color: #fff; font-size: 14px; margin-top: 20px; }

        /* --- CSS CHO MODAL (C·ª¨A S·ªî B·∫¨T L√äN) --- */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
        .modal-content { background-color: #fff3e0; margin: 10% auto; padding: 20px; border: 4px solid #d50000; width: 80%; max-width: 500px; border-radius: 15px; position: relative; color: #333; }
        .close-btn { color: #d50000; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: black; }
        .modal h2 { color: #d50000; border-bottom: 2px solid #ffb300; padding-bottom: 10px; }
        
        /* B·∫£ng chi ti·∫øt b√™n trong modal */
        .detail-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .detail-table th, .detail-table td { border: 1px solid #ffb300; padding: 8px; text-align: left; }
        .detail-table th { background-color: #ffcc80; color: #d50000; }
        .score-val { font-weight: bold; color: #d50000; }
    </style>
</head>
<body>

    <h1>üèÜ B·∫£ng X·∫øp H·∫°ng üèÜ</h1>
    <div class="sub-title">H·ªôi Thi Ti·∫øng H√°t M·ª´ng Xu√¢n üå∫</div>

    <div class="board" id="boardContent">
        </div>

    <div class="loading">D·ªØ li·ªáu c·∫≠p nh·∫≠t m·ªói 3 gi√¢y... (B·∫•m v√†o th√≠ sinh ƒë·ªÉ xem chi ti·∫øt)</div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Chi ti·∫øt ƒëi·ªÉm</h2>
            <div id="modalBody">ƒêang t·∫£i...</div>
        </div>
    </div>

<script>
    const API_URL = "/api"; // ƒê·∫£m b·∫£o ƒë√∫ng prefix API
    let isModalOpen = false; // ƒê·ªÉ tr√°nh refresh khi ƒëang xem chi ti·∫øt

    async function fetchLeaderboard() {
        if (isModalOpen) return; // N·∫øu ƒëang m·ªü modal th√¨ t·∫°m d·ª´ng update b·∫£ng x·∫øp h·∫°ng ƒë·ªÉ tr√°nh lag

        try {
            const res = await fetch(`${API_URL}/leaderboard`);
            const data = await res.json();
            renderBoard(data);
        } catch (e) {
            console.error("L·ªói k·∫øt n·ªëi:", e);
        }
    }

    function renderBoard(data) {
        const board = document.getElementById("boardContent");
        board.innerHTML = ""; 

        if (data.length === 0) {
            board.innerHTML = "<p style='color:white'>Ch∆∞a c√≥ d·ªØ li·ªáu th√≠ sinh n√†o...</p>";
            return;
        }

        data.forEach((item, index) => {
            const rank = index + 1;
            let specialClass = "";
            if(rank === 1) specialClass = "rank-1";
            else if(rank === 2) specialClass = "rank-2";
            else if(rank === 3) specialClass = "rank-3";

            // Th√™m s·ª± ki·ªán onclick ƒë·ªÉ xem chi ti·∫øt
            const html = `
                <div class="rank-item ${specialClass}" onclick="showDetails('${item.participant_id}', '${item.participant_name}')">
                    <div class="rank-number">#${rank}</div>
                    <div class="singer-name">
                        ${rank === 1 ? 'üëë ' : ''}${item.participant_name}
                    </div>
                    <div class="score-box">
                        <div class="avg-score">${item.average_score} ‚≠ê</div>
                        <div class="vote-count">${item.vote_count} l∆∞·ª£t ch·∫•m</div>
                    </div>
                </div>
            `;
            board.innerHTML += html;
        });
    }

    // --- C√ÅC H√ÄM X·ª¨ L√ù MODAL CHI TI·∫æT ---

    async function showDetails(id, name) {
        isModalOpen = true; // D·ª´ng auto refresh
        const modal = document.getElementById("detailModal");
        const title = document.getElementById("modalTitle");
        const body = document.getElementById("modalBody");

        title.innerText = `ƒêi·ªÉm s·ªë c·ªßa: ${name}`;
        body.innerHTML = "ƒêang t·∫£i d·ªØ li·ªáu...";
        modal.style.display = "block";

        try {
            // G·ªçi API chi ti·∫øt m·ªõi th√™m
            const res = await fetch(`${API_URL}/participants/${id}/details`);
            const details = await res.json();

            if (details.length === 0) {
                body.innerHTML = "<p>Ch∆∞a c√≥ ai ch·∫•m ƒëi·ªÉm cho th√≠ sinh n√†y.</p>";
            } else {
                let tableHtml = `
                    <table class="detail-table">
                        <thead><tr><th>Gi√°m Kh·∫£o</th><th>ƒêi·ªÉm</th></tr></thead>
                        <tbody>
                `;
                details.forEach(d => {
                    tableHtml += `
                        <tr>
                            <td>${d.judge_name}</td>
                            <td class="score-val">${d.score}</td>
                        </tr>`;
                });
                tableHtml += `</tbody></table>`;
                body.innerHTML = tableHtml;
            }
        } catch (e) {
            body.innerText = "L·ªói khi t·∫£i chi ti·∫øt!";
            console.error(e);
        }
    }

    function closeModal() {
        document.getElementById("detailModal").style.display = "none";
        isModalOpen = false; // Ti·∫øp t·ª•c auto refresh
    }

    // ƒê√≥ng modal khi b·∫•m ra ngo√†i v√πng tr·∫Øng
    window.onclick = function(event) {
        const modal = document.getElementById("detailModal");
        if (event.target == modal) {
            closeModal();
        }
    }

    fetchLeaderboard();
    setInterval(fetchLeaderboard, 3000);

</script>
</body>
</html>