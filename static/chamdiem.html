<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cháº¥m Äiá»ƒm Táº¿t ğŸ§§</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #b71c1c; color: #fff; margin: 0; padding: 20px; text-align: center; }
        .container { max-width: 500px; margin: 0 auto; background: #fff3e0; color: #333; padding: 20px; border-radius: 15px; border: 4px solid #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
        h1 { color: #d50000; }
        select, input, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 2px solid #ffb300; font-size: 16px; box-sizing: border-box; }
        button { background-color: #d50000; color: white; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background-color: #ffd700; color: #d50000; }
        .hidden { display: none; }
        .tet-deco { font-size: 40px; }
        .judge-badge { background: #ffe0b2; padding: 5px 10px; border-radius: 5px; color: #e65100; font-weight: bold; display: inline-block; margin-bottom: 10px;}
    </style>
</head>
<body>

<div class="container">
    <div class="tet-deco">ğŸŒ¸ ğŸ¤ ğŸŒ¸</div>
    <h1>Phiáº¿u Cháº¥m Äiá»ƒm</br>è©•åˆ†è¡¨</h1>

    <div id="loginSection">
        <p>Vui lÃ²ng nháº­p tÃªn GiÃ¡m Kháº£o Ä‘á»ƒ báº¯t Ä‘áº§u</br>è«‹è¼¸å…¥è©•å¯©å§“åä»¥é–‹å§‹</p>
        <input type="text" id="judgeNameInput" placeholder="TÃªn cá»§a báº¡n (VD: TÃ i, HÃ¹ng...)">
        <button onclick="saveJudge()">Báº¯t Ä‘áº§u Cháº¥m/é–‹å§‹è©•åˆ† ğŸ§§</button>
    </div>

    <div id="voteSection" class="hidden">
        <div>Xin chÃ o/ä½ å¥½: <span id="displayJudgeName" class="judge-badge"></span></div>
        <button onclick="logout()" style="width: auto; padding: 5px 10px; font-size: 12px; background:#555;">Äá»•i tÃªn/æ›´æ›å§“å</button>
        <hr style="border-color: #ffb300;">
        
        <label><b>Chá»n ThÃ­ Sinh/é¸æ“‡åƒè³½è€…</b></label>
        <select id="singerSelect">
            <option value="">-- Äang táº£i danh sÃ¡ch... --</option>
        </select>

        <label><b>Äiá»ƒm Sá»‘ /åˆ†æ•¸ (0 - 10)</b></label>
        <input type="number" id="scoreInput" min="0" max="10" step="0.1" placeholder="Nháº­p Ä‘iá»ƒm/è¼¸å…¥åˆ†æ•¸...">

        <button onclick="submitVote()">Gá»­i Káº¿t Quáº£/é€å‡ºçµæœ ğŸš€</button>
        <p id="message" style="margin-top: 10px; font-weight: bold;"></p>
    </div>
</div>

<script>
    const API_URL = "/api";
    
    // 1. Logic Quáº£n lÃ½ TÃªn GiÃ¡m Kháº£o
    function checkLogin() {
        const savedName = localStorage.getItem("judge_name");
        if (savedName) {
            document.getElementById("loginSection").classList.add("hidden");
            document.getElementById("voteSection").classList.remove("hidden");
            document.getElementById("displayJudgeName").innerText = savedName;
            loadParticipants(); // Táº£i danh sÃ¡ch thÃ­ sinh ngay khi vÃ o
        } else {
            document.getElementById("loginSection").classList.remove("hidden");
            document.getElementById("voteSection").classList.add("hidden");
        }
    }

    function saveJudge() {
        const rawName = document.getElementById("judgeNameInput").value.trim();
        if (!rawName) return alert("Vui lÃ²ng nháº­p tÃªn!");
        
        // Táº¡o mÃ£ ngáº«u nhiÃªn 4 kÃ½ tá»± Ä‘á»ƒ trÃ¡nh trÃ¹ng
        const randomCode = Math.floor(1000 + Math.random() * 9000); 
        const fullName = `${rawName}_#${randomCode}`;
        
        localStorage.setItem("judge_name", fullName);
        checkLogin();
    }

    function logout() {
        localStorage.removeItem("judge_name");
        location.reload();
    }

    // 2. Logic Gá»i API
    async function loadParticipants() {
        try {
            const res = await fetch(`${API_URL}/participants`);
            const data = await res.json();
            const select = document.getElementById("singerSelect");
            select.innerHTML = '<option value="">-- Chá»n thÃ­ sinh --</option>';
            data.forEach(p => {
                const option = document.createElement("option");
                option.value = p.id;
                option.text = p.name;
                select.add(option);
            });
        } catch (e) {
            console.error(e);
            alert("KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c vá»›i Server! HÃ£y kiá»ƒm tra file main.py");
        }
    }

    async function submitVote() {
        const participantId = document.getElementById("singerSelect").value;
        const score = parseFloat(document.getElementById("scoreInput").value);
        const judgeName = localStorage.getItem("judge_name");

        if (!participantId || isNaN(score)) return alert("Vui lÃ²ng chá»n thÃ­ sinh vÃ  nháº­p Ä‘iá»ƒm!");
        if (score < 0 || score > 10) return alert("Äiá»ƒm pháº£i tá»« 0 Ä‘áº¿n 10");

        const res = await fetch(`${API_URL}/vote`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ participant_id: participantId, judge_name: judgeName, score: score })
        });

        if (res.ok) {
        const msgBox = document.getElementById("message");
        
        // 1. Hiá»‡n thÃ´ng bÃ¡o
        msgBox.innerText = "âœ… ÄÃ£ cháº¥m xong! Tiáº¿p tá»¥c nÃ o.</br>è©•åˆ†å®Œæˆï¼ç¹¼çºŒä¸‹ä¸€ä½ã€‚";
        msgBox.style.color = "green";

        // 2. XÃ³a Ä‘iá»ƒm trong Ã´ nháº­p Ä‘á»ƒ trÃ¡nh nháº§m láº«n cho ngÆ°á»i sau
        document.getElementById("scoreInput").value = "";

        // 3. Äá»£i 2 giÃ¢y (2000ms) rá»“i táº¯t thÃ´ng bÃ¡o
        setTimeout(() => {
            msgBox.innerText = "";
        }, 2000);

    } else {
        const msgBox = document.getElementById("message");
        msgBox.innerText = "âŒ Lá»—i khi cháº¥m Ä‘iá»ƒm.";
        msgBox.style.color = "red";
        
        // CÅ©ng tá»± táº¯t thÃ´ng bÃ¡o lá»—i sau 3 giÃ¢y cho gá»n
        setTimeout(() => {
            msgBox.innerText = "";
        }, 3000);
    }
    }

    // Cháº¡y khi má»Ÿ web
    checkLogin();
</script>

</body>
</html>