<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ch·∫•m ƒêi·ªÉm T·∫øt üßß</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #b71c1c; color: #fff; margin: 0; padding: 20px; text-align: center; }
        .container { max-width: 500px; margin: 0 auto; background: #fff3e0; color: #333; padding: 20px; border-radius: 15px; border: 4px solid #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
        h1 { color: #d50000; }
        select, input, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 2px solid #ffb300; font-size: 16px; box-sizing: border-box; }
        button { background-color: #d50000; color: white; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background-color: #ffd700; color: #d50000; }
        .hidden { display: none; }
        .tet-deco { font-size: 40px; }
        .judge-badge { background: #ffe0b2; padding: 5px 10px; border-radius: 5px; color: #e65100; font-weight: bold; display: inline-block; margin-bottom: 10px;}
    </style>
</head>
<body>

<div class="container">
    <div class="tet-deco">üå∏ üé§ üå∏</div>
    <h1>Phi·∫øu Ch·∫•m ƒêi·ªÉm</h1>

    <div id="loginSection">
        <p>Vui l√≤ng nh·∫≠p t√™n Gi√°m Kh·∫£o ƒë·ªÉ b·∫Øt ƒë·∫ßu:</p>
        <input type="text" id="judgeNameInput" placeholder="T√™n c·ªßa b·∫°n (VD: T√†i, H√πng...)">
        <button onclick="saveJudge()">B·∫Øt ƒë·∫ßu Ch·∫•m üßß</button>
    </div>

    <div id="voteSection" class="hidden">
        <div>Xin ch√†o: <span id="displayJudgeName" class="judge-badge"></span></div>
        <button onclick="logout()" style="width: auto; padding: 5px 10px; font-size: 12px; background:#555;">ƒê·ªïi t√™n</button>
        <hr style="border-color: #ffb300;">
        
        <label><b>Ch·ªçn Th√≠ Sinh:</b></label>
        <select id="singerSelect">
            <option value="">-- ƒêang t·∫£i danh s√°ch... --</option>
        </select>

        <label><b>ƒêi·ªÉm S·ªë (0 - 10):</b></label>
        <input type="number" id="scoreInput" min="0" max="10" step="0.1" placeholder="Nh·∫≠p ƒëi·ªÉm...">

        <button onclick="submitVote()">G·ª≠i K·∫øt Qu·∫£ üöÄ</button>
        <p id="message" style="margin-top: 10px; font-weight: bold;"></p>
    </div>
</div>

<script>
    const API_URL = "/api";
    
    // 1. Logic Qu·∫£n l√Ω T√™n Gi√°m Kh·∫£o
    function checkLogin() {
        const savedName = localStorage.getItem("judge_name");
        if (savedName) {
            document.getElementById("loginSection").classList.add("hidden");
            document.getElementById("voteSection").classList.remove("hidden");
            document.getElementById("displayJudgeName").innerText = savedName;
            loadParticipants(); // T·∫£i danh s√°ch th√≠ sinh ngay khi v√†o
        } else {
            document.getElementById("loginSection").classList.remove("hidden");
            document.getElementById("voteSection").classList.add("hidden");
        }
    }

    function saveJudge() {
        const rawName = document.getElementById("judgeNameInput").value.trim();
        if (!rawName) return alert("Vui l√≤ng nh·∫≠p t√™n!");
        
        // T·∫°o m√£ ng·∫´u nhi√™n 4 k√Ω t·ª± ƒë·ªÉ tr√°nh tr√πng
        const randomCode = Math.floor(1000 + Math.random() * 9000); 
        const fullName = `${rawName}_#${randomCode}`;
        
        localStorage.setItem("judge_name", fullName);
        checkLogin();
    }

    function logout() {
        localStorage.removeItem("judge_name");
        location.reload();
    }

    // 2. Logic G·ªçi API
    async function loadParticipants() {
        try {
            const res = await fetch(`${API_URL}/participants`);
            const data = await res.json();
            const select = document.getElementById("singerSelect");
            select.innerHTML = '<option value="">-- Ch·ªçn th√≠ sinh --</option>';
            data.forEach(p => {
                const option = document.createElement("option");
                option.value = p.id;
                option.text = p.name;
                select.add(option);
            });
        } catch (e) {
            console.error(e);
            alert("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c v·ªõi Server! H√£y ki·ªÉm tra file main.py");
        }
    }

    async function submitVote() {
        const participantId = document.getElementById("singerSelect").value;
        const score = parseFloat(document.getElementById("scoreInput").value);
        const judgeName = localStorage.getItem("judge_name");

        if (!participantId || isNaN(score)) return alert("Vui l√≤ng ch·ªçn th√≠ sinh v√† nh·∫≠p ƒëi·ªÉm!");
        if (score < 0 || score > 10) return alert("ƒêi·ªÉm ph·∫£i t·ª´ 0 ƒë·∫øn 10");

        const res = await fetch(`${API_URL}/vote`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ participant_id: participantId, judge_name: judgeName, score: score })
        });

        if (res.ok) {
        const msgBox = document.getElementById("message");
        
        // 1. Hi·ªán th√¥ng b√°o
        msgBox.innerText = "‚úÖ ƒê√£ ch·∫•m xong! Ti·∫øp t·ª•c n√†o.";
        msgBox.style.color = "green";

        // 2. X√≥a ƒëi·ªÉm trong √¥ nh·∫≠p ƒë·ªÉ tr√°nh nh·∫ßm l·∫´n cho ng∆∞·ªùi sau
        document.getElementById("scoreInput").value = "";

        // 3. ƒê·ª£i 2 gi√¢y (2000ms) r·ªìi t·∫Øt th√¥ng b√°o
        setTimeout(() => {
            msgBox.innerText = "";
        }, 2000);

    } else {
        const msgBox = document.getElementById("message");
        msgBox.innerText = "‚ùå L·ªói khi ch·∫•m ƒëi·ªÉm.";
        msgBox.style.color = "red";
        
        // C≈©ng t·ª± t·∫Øt th√¥ng b√°o l·ªói sau 3 gi√¢y cho g·ªçn
        setTimeout(() => {
            msgBox.innerText = "";
        }, 3000);
    }
    }

    // Ch·∫°y khi m·ªü web
    checkLogin();
</script>

</body>
</html>